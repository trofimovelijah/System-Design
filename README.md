# Первый уровень: Базовый дизайн
## Функциональные требования
1. **Профили пользователей**:
   - пользователи могут создавать, сохранять и редактировать свои анкеты.
2. **Выставление оценки чужой анкете**: 
   - пользователям могут выставлять оценки другим анкетам (по принципу лайк/дизлайк).
3. **Доступ к приложению**:
   - осуществлять действия даже по просмотру могут только зарегистрированные пользователи.
5. **Соответствие**: 
   - когда два пользователя выставляют положительные оценки друг другу, считается, что они подходят друг другу, поэтому могут начать разговор.
6. **Уведомления**: 
   - пользователи получают уведомления о совпадениях и сообщениях.
7. **Медиаконтент**: 
   - пользователи могут загружать фотографии и короткие видеоролики.
8. **Чат в режиме реального времени**: 
   - совпадающие пользователи могут общаться в режиме реального времени.

## Нефункциональные требования
1. **Масштабируемость** для обеспечения высокой нагрузки: 
   - поддержка +-100 миллионов MAU (ежемесячно активных пользователей) и +-10 миллионов DAU (ежедневно активных пользователей).
2. **Доступность**: 
   - время безотказной работы составляет 99,9%.
3. **Быстродействие**: 
   - ответы в течение 200 мс на основные взаимодействия.
4. **Констистентность** (для чатов):
   - в чатах сообщения должны быть одинаковыми для всех пользователей, иначе случится драма и отказ в дальнейшем использовании сервиса
5. **Надёжность**:
   - надёжное хранение и передача пользовательских данных
7. **Устойчивость к разделению**:
   - географическая распределённость диктует необходимость 

Расчётные показатели по загрузке:
    10M пользователей * 100 images / 100000 секунд в дне= 10000 RPS — чтение;
    10K / 100 = 100 RPS — запись. Формирование заказов.

Сетевой трафик:
    10000 секунд * 500KB (вес 1 изображения в карточке товара) = 5GB/s;
    5GB/s * 100000/s *400 day = 200PB трафика.

Нагрузка на хранилище:
100M товаров * 10 изображений в карточке * 500KB = 500TB. При этом, если предусмотреть масштабирование, можем прибавить 20%.

Нагрузка на вычислительные мощности:
    Чтение / запись <= 10 instances;
    Сетевой трафик >= 40 instances;
    Хранилище <= 100 SSD ~ 20 physical instances or ~ 100 cloud instances.

Стоимость:
    $0.1 / gb * 200 000 000 GB = $20M;
    600TB * $300 = $180 000.
    
## Расчёт нагрузки
Исходим из предположения, что наше приложение позволяет отображать на странице до 10 фотографий и изображений средним размером в 500 кБ, либо 1 фото и максимум 9 коротких полуминутных видеороликов, оптимизированных под конкретное устройство, с которого происходит просмотр анкеты. Остальная информация в анкете (описание, история лайков и т.п.) несоизмеримо меньше по размерам. Предполагаемый размер видеоролика рассчитывается из следующего: FullHD-видео (1080p) длиной в час весит 1,5 ГБ (~420кБ, округляем до 500 кБ). 
### Запросы
   - 10M пользователей * 50 * (30 * 9 + 1) (предполагается, что пользователь просматривает по 50 анкет за сутки, включая всё видео и фото профиля) / 86400 секунд = 2М RPS (грубо округляем в сторону целого операции на чтение),
   - 100K пользователей * 10 медиа (фото+видео) = 1М RPS (на запись).

### Сетевой трафик
500кБ * 86400 секунд (в сутках) = 1296 Гб/с

### Вычислительные мощности

### Сетевая нагрузка

### Хранение данных


## Компоненты и взаимодействия
1. User service управляет анкетами пользователей
2. Auth service - сервис аутентификации
3. Match service (сервис сопоставлений) управляет логикой "нравится", "не нравится" и "соответствует"
4. Notification service (сервис уведомлений) отправляет различные виды уведомлений (push, смс, email) о совпадениях и сообщениях
5. Media service позволяет осуществлять загрузку и просмотр медиаконтента (изображения, короткие видео)
6. Chat service управляет чатом между пользователями в режиме реального времени.

## Высокоуровневый дизайн
1. **Фронтенд**:  мобильные приложения (iOS, Android) и веб-интерфейс.
2. **Бэкенд**: микросервисы.
4. Хранилище данных:
   - анкеты и соответствия: реляционная база данных (например, PostgreSQL)
   - Медиа-контент: распределённое хранилище файлов (например, S3-хранилище)
   - Сообщения в чате: база данных NoSQL (например, MongoDB)
4. Кэширование: Кэширование в памяти (например, БД типа ключ-значение наподобие Redis) для часто используемых данных.
5. Балансировка нагрузки: Распределение трафика с помощью балансировщиков нагрузки (например, Nginx, AWS ELB).

## Компонентный дизайн

## Хранилища и базы данных
1. Создание профиля: Пользователи создают профили, данные хранятся в реляционной базе данных.
2. "Нравится"/"не нравится": действия пользователя регистрируются, а совпадения идентифицируются службой сопоставления.
3. Уведомления: запускаются при совпадениях, уведомления отправляются через службу push-уведомлений.
4. Медиа-контент: Загруженные медиа хранятся в распределенном файловом хранилище.
5. Чат: Сообщения хранятся в базе данных NoSQL и извлекаются в режиме реального времени.

## Масштабирование системы и повышение надёжности


# Второй уровень: Фильтрация по геолокации и предпочтениям
## Дополнительные функциональные требования
1. Поиск по геолокации: Пользователи могут искать профили по радиусу или по конкретным местоположениям.
2. Фильтры предпочтений: Фильтруйте профили на основе предпочтений пользователя (возраст, интересы и т.д.).

## Усовершенствованная архитектура
1. Geolocation service Служба геолокации:
- Используйте геопространственную базу данных (например, PostGIS) для хранения и запроса данных о местоположении.
- Реализуйте стратегию сегментирования на основе дерева квадрантов или сетки, чтобы справиться с высокой плотностью пользователей в городах.
- Обеспечьте согласованность и синхронизацию между сегментами.
2. Служба поиска и фильтрации:
- Использует Elasticsearch для быстрого запроса и фильтрации.
- Индексирует профили пользователей с помощью атрибутов геолокации и предпочтений.

## Компоненты и взаимодействия
1. Geolocation service Служба геолокации:
- Хранит данные о местоположении в геопространственной базе данных.
- Предоставляет API для запроса пользователей по местоположению.
2. Search and Filtering Service Сервис поиска и фильтрации:
- Индексирует профили в Elasticsearch.
- Обрабатывает сложные запросы, объединяющие геолокацию и предпочтения.

## Базы данных
1. Обновление местоположения: Пользователи обновляют свое местоположение, данные хранятся в геопространственной базе данных.
2. Поиск по профилю: Пользователи выполняют поиск, отфильтрованные результаты возвращаются из Elasticsearch.

# Третий уровень: Обработка больших объемов данных и компонентов ML
## Дополнительные функциональные требования
1. Сбор данных о событиях: фиксирует 1 млн событий в секунду.
2. Компоненты ML:
- механизм рекомендаций для сортировки профилей.
- сервис Push-уведомлений для привлечения пользователей.

## Компоненты и взаимодействия
1. Обработчик потока событий Event Stream Processor :
- Принимает и обрабатывает события в режиме реального времени.
- Сохраняет обработанные данные в хранилище данных для аналитики.
2. Recommendation Service Служба рекомендаций:
- Использует модели ML для ранжирования и сортировки профилей.
- Извлекает функции из хранилища функций и обрабатывает рекомендации в режиме реального времени.
3. Служба Push-уведомлений:
- Использует модели ML для прогнозирования и своевременной отправки push-уведомлений.
- Отслеживает активность пользователей и запускает уведомления о привлечении.

## Высокоуровневый дизайн
1. Сбор данных о событиях и ETL:
   - платформа распределённой потоковой передачи событий (например, Apache Kafka) для обработки событий.
   - реализация конвейеров ETL для обработки и хранения данных в хранилище данных (например, Amazon Redshift).
2. Инфраструктура машинного обучения:
   - развёртывание модели ML с использованием масштабируемой платформы обслуживания (например, TensorFlow Serving).
   - использование хранилища функций для согласованного управления функциями ML.

## Компонентный дизайн

## Базы данных
1. Сбор событий: Действия пользователя генерируют события, которые обрабатываются и сохраняются обработчиком потока событий.
2. Механизм рекомендаций: запрашивает пользовательские данные, ранжирует профили и предоставляет персонализированные рекомендации.
3. Push-уведомления: запускает уведомления на основе поведения пользователя и моделей взаимодействия.

## Оценки и соображения
### Оценки нагрузки и трафика
1. 100M MAU и 10M DAU:
   - Учет пиковой нагрузки при тысячах запросов в секунду.
   - Высокая пропускная способность баз данных и систем хранения данных для чтения и записи.
### Оценка затрат
1. Затраты на трафик: Оценка на основе передачи данных и использования CDN.
2. Затраты на хранение: Для реляционных, NoSQL и мультимедийных хранилищ.
3. Вычислительные затраты: Для запуска серверных служб, моделей ML и процессов ETL.
### Reliability and Responsiveness Надежность и оперативность
1. Избыточность: Развертывание в нескольких регионах для аварийного восстановления.
2. Масштабируемость: Автоматическое масштабирование групп и бессерверные функции для обработки изменений нагрузки.
3. Мониторинг и оповещения: Используйте такие инструменты, как Prometheus и Grafana, для мониторинга и оповещения в режиме реального времени.
### Соображения безопасности
1. Шифрование данных: Шифруйте данные в состоянии покоя и при передаче.
2. Аутентификация и авторизация: Реализуйте надежную аутентификацию (например, OAuth2) и управление доступом на основе ролей.
3. Соответствие требованиям: Обеспечьте соблюдение правил защиты данных (например, GDPR, CCPA).

### Мониторинг и взаимодействие системы
